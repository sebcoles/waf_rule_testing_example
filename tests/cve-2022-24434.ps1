## CVE 2022-24434
## Dicer header parser flaw

## Install test framework
Install-Module Pester -Force -Scope CurrentUser -SkipPublisherCheck
Import-Module Pester -PassThru

## Variables
$Uri = 'https://cvetestfd.azurefd.net/'

Describe 'Testing CVE-2022-24434 against the WAF policy' {

    It 'Given the payload does not contain the trigger values, the response should be 200 OK' {

        # Arrange
        $StatusCode
        $Body = "vote=Dogs"
        
        try {
            # Act
            $Result = Invoke-WebRequest -ContentType "application/x-www-form-urlencoded" -Uri $Uri -Method Post -Body $Body
            $StatusCode = $Result.StatusCode 
        } catch {
            $StatusCode = $_.Exception.Response.StatusCode.value__ 
        }
        # Assert
        $StatusCode | Should -Be 200
    }

    It 'Given the payload DOES contain the trigger values, the response should be 403 Forbidden' {
        # Arrange
        $StatusCode
        $Body = "------WebKitFormBoundaryoo6vortfDzBsDiro\r\n Content-Disposition: form-data; name=`"bildbeschreibung`"\r\n\r\n\r\n------WebKitFormBoundaryoo6vortfDzBsDiro--"

        try {
            # Act
            $Result = Invoke-RestMethod -ContentType "application/x-www-form-urlencoded" -Uri $Uri -Method Post -Body $Body
            $StatusCode = $Result.StatusCode 
        } catch {
            $StatusCode = $_.Exception.Response.StatusCode.value__ 
        }

        Write-Host $Result.Content
        # Assert
        $StatusCode | Should -Be 403
    }
}


## Test 1
